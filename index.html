<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教練排程系統</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
            --white: #ffffff;
            --gray: #808080;
            --bg: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* Loading 畫面 */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--green-light), var(--pink-light));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--green-light);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Error 畫面 */
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
        }

        .error-screen.hidden {
            display: none;
        }

        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .error-message {
            font-size: 16px;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 24px;
            max-width: 400px;
        }

        .error-btn {
            padding: 14px 32px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .error-btn:hover {
            background: var(--green-dark);
        }

        /* 主要內容 */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .navbar {
            background: linear-gradient(135deg, var(--green-light), var(--pink-light), var(--yellow-light));
            padding: 16px 20px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--green), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .user-info h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 3px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 1px;
        }

        .user-info p:last-child {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0;
        }

        .container {
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.green::before { background: var(--green); }
        .stat-card.pink::before { background: var(--pink); }
        .stat-card.yellow::before { background: var(--yellow); }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
        }

        .stat-card.green .stat-value { color: var(--green); }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.yellow .stat-value { color: var(--yellow); }

        /* 狀態說明卡片 */
        .legend-card {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .legend-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg);
        }

        .legend-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .legend-label {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .legend-item.available {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .legend-item.reserved {
            background: var(--yellow-light);
            color: var(--yellow-dark);
        }

        .legend-item.booked {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .quick-actions {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .quick-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .quick-btn {
            padding: 10px 6px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            font-family: inherit;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .quick-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quick-btn:active::before {
            opacity: 1;
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        .quick-btn:nth-child(1) {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .quick-btn:nth-child(1)::before {
            background: var(--blue);
        }

        .quick-btn:nth-child(2) {
            background: var(--yellow-light);
            color: var(--yellow-dark);
        }

        .quick-btn:nth-child(2)::before {
            background: var(--yellow);
        }

        .quick-btn:nth-child(3) {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .quick-btn:nth-child(3)::before {
            background: var(--green);
        }

        .quick-btn:nth-child(4) {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .quick-btn:nth-child(4)::before {
            background: var(--pink);
        }

        .quick-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .calendar-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--green-light);
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-nav button {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--green-light);
            color: var(--green-dark);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .week-nav button:active {
            transform: scale(0.95);
            background: var(--green);
            color: white;
        }

        #weekRange {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            min-width: 140px;
            text-align: center;
        }

        /* 固定日期列 */
        .calendar-wrapper {
            position: relative;
        }

        .date-header-sticky {
            position: sticky;
            top: 80px;
            background: var(--white);
            z-index: 50;
            margin: 0 -16px;
            padding: 10px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .date-row {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }

        .date-cell {
            text-align: center;
            padding: 6px 2px;
            border-radius: 6px;
            font-size: 11px;
        }

        .date-cell.empty {
            background: transparent;
        }

        .date-cell.day {
            background: var(--green-light);
            font-weight: 600;
            color: var(--green-dark);
        }

        .date-cell.day.today {
            background: var(--green);
            color: white;
            position: relative;
        }

        .date-cell.day.today::after {
            content: '●';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 6px;
        }

        .date-label {
            font-size: 9px;
            color: var(--text-light);
            display: block;
        }

        .date-number {
            font-size: 13px;
            font-weight: 600;
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 4px;
        }

        .time-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            padding: 6px 2px;
        }

        .slot-cell {
            border-radius: 6px;
            border: 2px solid var(--green-light);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 40px;
            height: 100%;
        }

        .slot-cell:active {
            transform: scale(0.92);
        }

        /* 可預約時段(已選擇) */
        .slot-cell.selected {
            background: var(--green);
            border-color: var(--green-dark);
        }

        .slot-cell.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* 保留中時段 */
        .slot-cell.reserved {
            background: linear-gradient(135deg, var(--yellow), var(--yellow-dark));
            border-color: var(--yellow-dark);
            cursor: not-allowed;
            pointer-events: auto;
        }

        .slot-cell.reserved::after {
            content: '⏳';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        /* 倒數計時顯示 */
        .slot-cell.reserved .countdown {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            line-height: 1;
        }

        /* Hover 顯示保留資訊 */
        .slot-cell.reserved[data-student]:hover::before {
            content: '保留中: ' attr(data-student) '\A剩餘: ' attr(data-remaining);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: pre;
            z-index: 100;
            text-align: center;
            line-height: 1.4;
            box-shadow: var(--shadow-md);
        }

        /* 已預約時段 */
        .slot-cell.booked {
            background: linear-gradient(135deg, var(--blue), var(--blue-dark));
            border-color: var(--blue-dark);
            cursor: not-allowed;
            pointer-events: auto;
        }

        .slot-cell.booked::after {
            content: '👤';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        /* Hover 顯示學員名稱 */
        .slot-cell.booked[data-student]:hover::before {
            content: '已預約: ' attr(data-student);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.97);
            background: var(--green-dark);
        }

        .btn-secondary {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .btn-secondary:active {
            transform: scale(0.97);
            background: var(--pink);
            color: white;
        }

        /* 範本管理 */
        .template-section {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--blue-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:active {
            transform: scale(0.98);
            background: var(--blue);
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-weight: 600;
            color: var(--blue-dark);
            font-size: 13px;
        }

        .template-count {
            font-size: 11px;
            color: var(--text-light);
        }

        .template-actions {
            display: flex;
            gap: 6px;
        }

        .template-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn.load {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .template-btn.delete {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: var(--shadow-lg);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .modal-content {
            margin-bottom: 16px;
        }

        .modal-info {
            background: var(--green-light);
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .modal-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .modal-info-row:last-child {
            border-bottom: none;
        }

        .modal-label {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
        }

        .modal-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-note {
            background: var(--yellow-light);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--yellow-dark);
            text-align: center;
            margin-bottom: 8px;
        }

        .modal-note.add {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .modal-note.delete {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--green-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 12px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--green);
        }

        /* 確認排程列表 */
        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--green-light);
            border-radius: 8px;
        }

        .schedule-item.add {
            background: var(--green-light);
            border-left: 4px solid var(--green);
        }

        .schedule-item.delete {
            background: var(--pink-light);
            border-left: 4px solid var(--pink);
        }

        .schedule-date {
            font-weight: 600;
            color: var(--green-dark);
            font-size: 13px;
        }

        .schedule-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            transition: transform 0.3s;
            font-weight: 500;
            font-size: 14px;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* 平板優化 */
        @media (min-width: 768px) {
            .navbar {
                padding: 20px;
            }

            .avatar {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .user-info h1 {
                font-size: 18px;
            }

            .user-info p {
                font-size: 14px;
            }

            .user-info p:last-child {
                font-size: 15px;
            }

            .container {
                padding: 20px;
            }

            .stats-grid {
                gap: 12px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 20px 16px;
            }

            .stat-icon {
                font-size: 28px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-value {
                font-size: 32px;
            }

            .quick-actions, .template-section, .calendar-card, .legend-card {
                padding: 16px;
                margin-bottom: 12px;
            }

            .quick-title, .legend-title {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .quick-btn {
                padding: 12px 8px;
                font-size: 13px;
            }

            .quick-icon {
                font-size: 24px;
                margin-bottom: 4px;
            }

            .calendar-header h2 {
                font-size: 18px;
            }

            .week-nav button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            #weekRange {
                font-size: 15px;
                min-width: 180px;
            }

            .date-header-sticky {
                top: 96px;
                padding: 12px 16px;
            }

            .date-row {
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 6px;
                margin-bottom: 12px;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }

            .date-cell {
                padding: 8px 4px;
                font-size: 12px;
            }

            .date-label {
                font-size: 10px;
            }

            .date-number {
                font-size: 14px;
            }

            .calendar-grid {
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 6px;
                max-width: 800px;
                margin: 0 auto;
            }

            .time-label {
                font-size: 11px;
                padding: 6px 4px;
                min-height: 50px;
            }

            .slot-cell {
                border-radius: 8px;
                min-height: 50px;
                height: 50px;
            }

            .slot-cell.selected::after,
            .slot-cell.reserved::after,
            .slot-cell.booked::after {
                font-size: 16px;
            }

            .btn {
                padding: 16px;
                font-size: 16px;
            }

            .template-name {
                font-size: 14px;
            }

            .template-count {
                font-size: 12px;
            }

            .template-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .schedule-date {
                font-size: 14px;
            }

            .schedule-time {
                font-size: 13px;
            }

            .modal {
                padding: 24px;
            }

            .modal-header {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .toast {
                font-size: 14px;
                padding: 16px 24px;
            }
        }

        /* 桌面優化 */
        @media (min-width: 1024px) {
            .quick-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .calendar-grid {
                gap: 8px;
                max-width: 1000px;
                margin: 0 auto;
            }

            .time-label {
                padding: 6px 4px;
                min-height: 55px;
            }

            .slot-cell {
                min-height: 55px;
                height: 55px;
            }

            .date-row {
                gap: 8px;
                max-width: 1000px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 12px;
            }
        }

        /* 小螢幕優化 */
        @media (max-width: 360px) {
            .quick-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-btn {
                padding: 8px 4px;
                font-size: 11px;
            }

            .quick-icon {
                font-size: 18px;
            }

            #weekRange {
                font-size: 12px;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading 畫面 -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在載入教練資料...</div>
    </div>

    <!-- Error 畫面 -->
    <div class="error-screen hidden" id="errorScreen">
        <div class="error-icon">⚠️</div>
        <div class="error-title">無法載入資料</div>
        <div class="error-message" id="errorMessage">
            找不到教練資料,請確認網址參數是否正確。
        </div>
        <button class="error-btn" onclick="location.reload()">重新載入</button>
    </div>

    <!-- 主要內容 -->
    <div class="main-content" id="mainContent">
        <!-- 導航欄 -->
        <nav class="navbar">
            <div class="user-profile">
                <div class="avatar" id="avatarIcon">👨‍🏫</div>
                <div class="user-info">
                    <h1 id="systemTitle">教練排程系統</h1>
                    <p id="teacherType">課程類型</p>
                    <p id="teacherName">教練名稱</p>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- 統計卡片 -->
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-icon">📅</div>
                    <div class="stat-label">兩週總計</div>
                    <div class="stat-value" id="totalSelected">0</div>
                </div>
                <div class="stat-card pink">
                    <div class="stat-icon">⏰</div>
                    <div class="stat-label">本週選擇</div>
                    <div class="stat-value" id="weekCount">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-icon">📊</div>
                    <div class="stat-label">總時段</div>
                    <div class="stat-value" id="totalCount">126</div>
                </div>
            </div>

            <!-- 狀態說明 -->
            <div class="legend-card">
                <div class="legend-title">🎨 時段狀態說明</div>
                <div class="legend-grid">
                    <div class="legend-item available">
                        <div class="legend-icon">✓</div>
                        <div class="legend-label">可預約</div>
                    </div>
                    <div class="legend-item reserved">
                        <div class="legend-icon">⏳</div>
                        <div class="legend-label">保留中</div>
                    </div>
                    <div class="legend-item booked">
                        <div class="legend-icon">👤</div>
                        <div class="legend-label">已預約</div>
                    </div>
                </div>
            </div>

            <!-- 快速操作 -->
            <div class="quick-actions">
                <div class="quick-title">⚡ 快速操作</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="copyLastWeek()">
                        <span class="quick-icon">📋</span>
                        複製上週
                    </button>
                    <button class="quick-btn" onclick="showSaveTemplateModal()">
                        <span class="quick-icon">💾</span>
                        儲存範本
                    </button>
                    <button class="quick-btn" onclick="selectAll()">
                        <span class="quick-icon">✓</span>
                        全選
                    </button>
                    <button class="quick-btn" onclick="clearAll()">
                        <span class="quick-icon">✕</span>
                        清除
                    </button>
                </div>
            </div>

            <!-- 範本管理 -->
            <div class="template-section">
                <div class="template-header">
                    <div class="quick-title">📚 我的範本</div>
                </div>
                <div class="template-list" id="templateList">
                    <div style="text-align: center; color: var(--text-light); padding: 16px; font-size: 12px;">
                        尚無儲存的範本
                    </div>
                </div>
            </div>

            <!-- 日曆 -->
            <div class="calendar-card">
                <div class="calendar-header">
                    <h2>📅 排程管理</h2>
                    <div class="week-nav">
                        <button onclick="previousWeek()">◀</button>
                        <span id="weekRange"></span>
                        <button onclick="nextWeek()">▶</button>
                    </div>
                </div>
                
                <div class="calendar-wrapper">
                    <!-- 固定的日期標題 -->
                    <div class="date-header-sticky">
                        <div class="date-row" id="dateRow"></div>
                    </div>
                    
                    <!-- 時間格子 -->
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showSaveModal()">送出排程(兩週內所有時段)</button>
            </div>
        </div>
    </div>

    <!-- 儲存確認 Modal -->
    <div class="modal-overlay hidden" id="saveModalOverlay">
        <div class="modal">
            <div class="modal-header">💾 確認送出排程(兩週內所有時段)</div>
            <div class="modal-content">
                <div class="modal-info">
                    <div class="modal-info-row">
                        <span class="modal-label">教練</span>
                        <span class="modal-value" id="modalCoachName">-</span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-label">類型</span>
                        <span class="modal-value" id="modalCoachType">-</span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-label">兩週總時段</span>
                        <span class="modal-value" id="modalTotalCount">0</span>
                    </div>
                </div>
                <div id="changesInfo"></div>
                <div class="schedule-list" id="confirmScheduleList"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideSaveModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmSave()">確認送出</button>
            </div>
        </div>
    </div>

    <!-- 儲存範本 Modal -->
    <div class="modal-overlay hidden" id="saveTemplateModalOverlay">
        <div class="modal">
            <div class="modal-header">💾 儲存為範本</div>
            <div class="modal-content">
                <input type="text" class="modal-input" id="templateNameInput" placeholder="請輸入範本名稱(例如:週一三五固定班)">
                <div class="modal-note">
                    將保存目前選擇的 <span id="templateSlotCount">0</span> 個時段
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideSaveTemplateModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmSaveTemplate()">確認儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast 提示 -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== 配置 ==========
        const SPREADSHEET_ID = '1WPrkqpOycQ0NvLmP8RYCIyxNl3Rn8kzfXFCIe50pfMg';
        const API_KEY = 'YOUR_GOOGLE_API_KEY';
        const SHEET_NAME = 'Sheet1';
        const WEBHOOK_URL = 'https://hook.us2.make.com/nohow7z27lfcp32ryrksdts3yhdoblxg';

        // ========== 全域變數 ==========
        const TIME_SLOTS = [
            '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
        ];
        const DAYS = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        const DAYS_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        let currentTeacher = '';
        let currentTeacherType = '';
        let currentClass = '';
        let currentWeekStart = getMonday(new Date());
        let currentWeekEnd = new Date(currentWeekStart);
        currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
        
        let originalSchedule = {}; // 按週儲存原始排程
        let selectedSlots = {};    // 按週儲存選擇的時段(只有 available)
        let reservedSlots = {};    // 按週儲存保留中的時段
        let bookedSlots = {};      // 按週儲存已預約的時段
        let countdownIntervals = []; // 倒數計時器

        // ========== 初始化 ==========
        window.onload = async function() {
            await initializeApp();
        };

        async function initializeApp() {
            try {
                console.log('🚀 開始初始化...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const teacherParam = urlParams.get('teacher') || urlParams.get('coach') || urlParams.get('name');
                const typeParam = urlParams.get('type') || '';
                const classParam = urlParams.get('class') || '';
                
                console.log('📌 網址參數:', { teacher: teacherParam, type: typeParam, class: classParam });
                
                if (!teacherParam) {
                    showError('網址缺少參數', '請使用正確的連結,例如:?teacher=Kai&type=肌肉賦能伸展');
                    return;
                }

                // 直接使用網址參數
                currentTeacher = teacherParam;
                currentTeacherType = typeParam || '教練';
                currentClass = classParam;

                console.log('✅ 教練設定完成:', { name: currentTeacher, type: currentTeacherType });

                // 更新 UI
                document.getElementById('systemTitle').textContent = '教練排程系統';
                document.getElementById('teacherType').textContent = currentTeacherType;
                document.getElementById('teacherName').textContent = currentClass 
                    ? `${currentTeacher} | ${currentClass}` 
                    : currentTeacher;
                
                const avatarIcon = getAvatarIcon(currentTeacherType);
                document.getElementById('avatarIcon').textContent = avatarIcon;

                updateWeekDisplay();
                generateCalendar();

                // 從雲端載入最新資料
                console.log('☁️ 開始載入雲端排程...');
                await loadScheduleFromCloud();
                
                // 如果雲端沒有資料,才使用 LocalStorage
                if (Object.keys(selectedSlots).length === 0 && Object.keys(reservedSlots).length === 0 && Object.keys(bookedSlots).length === 0) {
                    console.log('💾 雲端無資料,載入本地備份...');
                    loadFromLocalStorage();
                }

                loadTemplates();
                updateStats();

                console.log('✅ 初始化完成!');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('show');

            } catch (error) {
                console.error('❌ 初始化錯誤:', error);
                showError('載入失敗', '無法載入教練資料:' + error.message);
            }
        }

        // ========== 從雲端載入排程 ==========
        async function loadScheduleFromCloud() {
            try {
                console.log('📥 正在從雲端載入排程...');
                
                // 計算兩週範圍
                const endDate = new Date(currentWeekStart);
                endDate.setDate(endDate.getDate() + 14);
                
                const payload = {
                    action: 'load',
                    userName: currentTeacher,
                    coachType: currentTeacherType,
                    startDate: formatDateISO(currentWeekStart),
                    endDate: formatDateISO(endDate)
                };
                
                console.log('📤 發送請求:', payload);
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('📨 回應狀態:', response.status, response.statusText);

                if (!response.ok) {
                    console.warn('⚠️ 雲端載入失敗:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('📦 收到資料:', data);
                
                if (data.success && data.schedules && data.schedules.length > 0) {
                    console.log(`✅ 從雲端載入 ${data.schedules.length} 個排程`);
                    
                    // 清空現有資料
                    originalSchedule = {};
                    selectedSlots = {};
                    reservedSlots = {};
                    bookedSlots = {};
                    
                    // 處理每個排程
                    data.schedules.forEach((schedule, index) => {
                        console.log(`處理排程 ${index + 1}:`, schedule);
                        
                        const date = new Date(schedule.date);
                        const weekStart = getMonday(date);
                        const weekKey = getWeekKey(weekStart);
                        
                        const dayOfWeek = date.getDay();
                        const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                        
                        const timeIndex = TIME_SLOTS.indexOf(schedule.startTime);
                        const slotKey = `${dayIndex}-${timeIndex}`;
                        
                        console.log(`  日期: ${schedule.date}, 星期: ${dayOfWeek}, dayIndex: ${dayIndex}, timeIndex: ${timeIndex}`);
                        console.log(`  狀態: ${schedule.status}, 學生: ${schedule.studentName || '無'}`);
                        
                        if (timeIndex >= 0) {
                            // 儲存到 originalSchedule
                            if (!originalSchedule[weekKey]) {
                                originalSchedule[weekKey] = [];
                            }
                            originalSchedule[weekKey].push({
                                date: schedule.date,
                                startTime: schedule.startTime,
                                endTime: schedule.endTime || getEndTime(schedule.startTime),
                                endDate: schedule.endDate || schedule.date,
                                status: schedule.status || 'available',
                                studentName: schedule.studentName || '',
                                reservedUntil: schedule.reservedUntil || ''
                            });
                            
                            // 根據狀態分類儲存
                            if (schedule.status === 'available' || !schedule.status) {
                                // 可預約 → 加入 selectedSlots
                                if (!selectedSlots[weekKey]) {
                                    selectedSlots[weekKey] = [];
                                }
                                if (!selectedSlots[weekKey].includes(slotKey)) {
                                    selectedSlots[weekKey].push(slotKey);
                                    console.log(`  ✅ 加入 selectedSlots: ${slotKey}`);
                                }
                            } else if (schedule.status === 'reserved') {
                                // 保留中 → 加入 reservedSlots
                                if (!reservedSlots[weekKey]) {
                                    reservedSlots[weekKey] = [];
                                }
                                reservedSlots[weekKey].push({
                                    slotKey: slotKey,
                                    studentName: schedule.studentName || '學員',
                                    reservedUntil: schedule.reservedUntil,
                                    date: schedule.date,
                                    startTime: schedule.startTime
                                });
                                console.log(`  ⏳ 加入 reservedSlots: ${slotKey}, 學生: ${schedule.studentName}`);
                            } else if (schedule.status === 'booked') {
                                // 已預約 → 加入 bookedSlots
                                if (!bookedSlots[weekKey]) {
                                    bookedSlots[weekKey] = [];
                                }
                                bookedSlots[weekKey].push({
                                    slotKey: slotKey,
                                    studentName: schedule.studentName || '學員',
                                    date: schedule.date,
                                    startTime: schedule.startTime
                                });
                                console.log(`  👤 加入 bookedSlots: ${slotKey}, 學生: ${schedule.studentName}`);
                            }
                        } else {
                            console.warn(`  ⚠️ 無效的時間: ${schedule.startTime}`);
                        }
                    });
                    
                    console.log('📊 處理完成:', {
                        originalSchedule: Object.keys(originalSchedule).length,
                        selectedSlots: Object.keys(selectedSlots).reduce((sum, key) => sum + selectedSlots[key].length, 0),
                        reservedSlots: Object.keys(reservedSlots).reduce((sum, key) => sum + reservedSlots[key].length, 0),
                        bookedSlots: Object.keys(bookedSlots).reduce((sum, key) => sum + bookedSlots[key].length, 0)
                    });
                    
                    saveToLocalStorage();
                    restoreWeekSelection();
                    updateStats();
                    
                    showToast(`✅ 已載入 ${data.schedules.length} 個排程`);
                    
                } else {
                    console.log('ℹ️ 雲端無排程資料');
                }

            } catch (error) {
                console.error('❌ 載入雲端排程失敗:', error);
                showToast('⚠️ 無法連接雲端,使用本地資料');
            }
        }

        // ========== Google Sheets API (已停用,改用網址參數) ==========
        // 保留函數以防未來需要,但目前不使用
        
        function getAvatarIcon(type) {
            const icons = {
                'AI 3D體態檢測': '🤖',
                '皮拉提斯': '🧘',
                '重訓': '💪',
                '肌肉賦能伸展': '🤸'
            };
            return icons[type] || '👨‍🏫';
        }

        function showError(title, message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.querySelector('.error-title').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }

        // ========== LocalStorage 相關 ==========
        function saveToLocalStorage() {
            const storageKey = `coachSchedule_${currentTeacher}_${currentClass}`;
            const data = {
                teacher: currentTeacher,
                type: currentTeacherType,
                class: currentClass,
                selectedSlots: selectedSlots,
                reservedSlots: reservedSlots,
                bookedSlots: bookedSlots
            };
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const storageKey = `coachSchedule_${currentTeacher}_${currentClass}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                const data = JSON.parse(saved);
                selectedSlots = data.selectedSlots || {};
                reservedSlots = data.reservedSlots || {};
                bookedSlots = data.bookedSlots || {};
                restoreWeekSelection();
            }
        }

        function restoreWeekSelection() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekSlots = selectedSlots[weekKey] || [];
            const weekReserved = reservedSlots[weekKey] || [];
            const weekBooked = bookedSlots[weekKey] || [];
            
            console.log('🔄 恢復本週選擇:', {
                weekKey,
                available: weekSlots.length,
                reserved: weekReserved.length,
                booked: weekBooked.length
            });
            
            // 清除舊的倒數計時器
            countdownIntervals.forEach(interval => clearInterval(interval));
            countdownIntervals = [];
            
            document.querySelectorAll('.slot-cell').forEach((cell, index) => {
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                const slotKey = `${dayIndex}-${timeIndex}`;
                
                // 清除所有狀態
                cell.classList.remove('selected', 'booked', 'reserved');
                cell.removeAttribute('data-student');
                cell.removeAttribute('data-remaining');
                cell.innerHTML = '';
                
                // 檢查是否為已預約
                const bookedSlot = weekBooked.find(b => b.slotKey === slotKey);
                if (bookedSlot) {
                    cell.classList.add('booked');
                    if (bookedSlot.studentName) {
                        cell.setAttribute('data-student', bookedSlot.studentName);
                    }
                    console.log(`  👤 已預約: ${slotKey}, 學生: ${bookedSlot.studentName}`);
                    return;
                }
                
                // 檢查是否為保留中
                const reservedSlot = weekReserved.find(r => r.slotKey === slotKey);
                if (reservedSlot) {
                    cell.classList.add('reserved');
                    if (reservedSlot.studentName) {
                        cell.setAttribute('data-student', reservedSlot.studentName);
                    }
                    console.log(`  ⏳ 保留中: ${slotKey}, 學生: ${reservedSlot.studentName}, 期限: ${reservedSlot.reservedUntil}`);
                    
                    // 啟動倒數計時
                    if (reservedSlot.reservedUntil) {
                        startCountdown(cell, reservedSlot.reservedUntil, weekKey, slotKey);
                    }
                    return;
                }
                
                // 檢查是否為可預約(已選擇)
                if (weekSlots.includes(slotKey)) {
                    cell.classList.add('selected');
                    console.log(`  ✅ 可預約: ${slotKey}`);
                }
            });
            
            updateStats();
        }

        // ========== 倒數計時 ==========
        function startCountdown(cell, reservedUntil, weekKey, slotKey) {
            const updateCountdown = () => {
                const now = new Date();
                const until = new Date(reservedUntil);
                const diff = until - now;
                
                if (diff <= 0) {
                    // 時間到了,自動釋放
                    cell.classList.remove('reserved');
                    cell.classList.add('selected');
                    cell.removeAttribute('data-student');
                    cell.removeAttribute('data-remaining');
                    cell.innerHTML = '';
                    
                    // 從 reservedSlots 移除
                    if (reservedSlots[weekKey]) {
                        reservedSlots[weekKey] = reservedSlots[weekKey].filter(
                            r => r.slotKey !== slotKey
                        );
                    }
                    
                    // 加入 selectedSlots
                    if (!selectedSlots[weekKey]) {
                        selectedSlots[weekKey] = [];
                    }
                    if (!selectedSlots[weekKey].includes(slotKey)) {
                        selectedSlots[weekKey].push(slotKey);
                    }
                    
                    saveToLocalStorage();
                    updateStats();
                    showToast('⏰ 保留時間已到,時段已自動釋放');
                    
                    return true; // 停止計時
                }
                
                // 計算剩餘時間
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                // 更新顯示
                cell.setAttribute('data-remaining', `${minutes}分${seconds}秒`);
                
                // 在格子上顯示剩餘分鐘數
                let countdownDiv = cell.querySelector('.countdown');
                if (!countdownDiv) {
                    countdownDiv = document.createElement('div');
                    countdownDiv.className = 'countdown';
                    cell.appendChild(countdownDiv);
                }
                countdownDiv.textContent = `${minutes}m`;
                
                return false;
            };
            
            // 立即執行一次
            if (updateCountdown()) return;
            
            // 每秒更新
            const interval = setInterval(() => {
                if (updateCountdown()) {
                    clearInterval(interval);
                }
            }, 1000);
            
            countdownIntervals.push(interval);
        }

        function getWeekKey(date) {
            return formatDateISO(date);
        }

        // ========== 範本管理 ==========
        function loadTemplates() {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const templateList = document.getElementById('templateList');
            
            if (templates.length === 0) {
                templateList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 16px; font-size: 12px;">尚無儲存的範本</div>';
                return;
            }
            
            templateList.innerHTML = templates.map((template, index) => `
                <div class="template-item">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <div class="template-count">${template.slots.length} 個時段</div>
                    </div>
                    <div class="template-actions">
                        <button class="template-btn load" onclick="loadTemplate(${index})">載入</button>
                        <button class="template-btn delete" onclick="deleteTemplate(${index})">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        function showSaveTemplateModal() {
            const count = document.querySelectorAll('.slot-cell.selected').length;
            if (count === 0) {
                showToast('❌ 請先選擇要儲存的時段');
                return;
            }
            
            document.getElementById('templateSlotCount').textContent = count;
            document.getElementById('templateNameInput').value = '';
            document.getElementById('saveTemplateModalOverlay').classList.remove('hidden');
        }

        function hideSaveTemplateModal() {
            document.getElementById('saveTemplateModalOverlay').classList.add('hidden');
        }

        function confirmSaveTemplate() {
            const name = document.getElementById('templateNameInput').value.trim();
            if (!name) {
                showToast('❌ 請輸入範本名稱');
                return;
            }
            
            const selectedCells = document.querySelectorAll('.slot-cell.selected');
            const slots = [];
            
            selectedCells.forEach(cell => {
                const index = parseInt(cell.dataset.index);
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                slots.push(`${dayIndex}-${timeIndex}`);
            });
            
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            templates.push({
                name: name,
                slots: slots,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem(storageKey, JSON.stringify(templates));
            
            hideSaveTemplateModal();
            loadTemplates();
            showToast(`💾 範本「${name}」已儲存`);
        }

        function loadTemplate(index) {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const template = templates[index];
            
            if (!template) return;
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            template.slots.forEach(slotKey => {
                const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                const cellIndex = timeIndex * 7 + dayIndex;
                const cell = document.querySelector(`.slot-cell[data-index="${cellIndex}"]`);
                if (cell && !cell.classList.contains('booked') && !cell.classList.contains('reserved')) {
                    cell.classList.add('selected');
                }
            });
            
            saveCurrentWeekSelection();
            updateStats();
            showToast(`✓ 已載入範本「${template.name}」`);
        }

        function deleteTemplate(index) {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const template = templates[index];
            
            if (!confirm(`確定要刪除範本「${template.name}」嗎?`)) return;
            
            templates.splice(index, 1);
            localStorage.setItem(storageKey, JSON.stringify(templates));
            
            loadTemplates();
            showToast(`🗑️ 已刪除範本「${template.name}」`);
        }

        // ========== 日期處理 ==========
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateTime(date, time) {
            return `${formatDateISO(date)}T${time}:00`;
        }

        function getEndTime(startTime) {
            const [hour, minute] = startTime.split(':').map(Number);
            const endHour = hour + 1;
            return `${String(endHour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }

        function updateWeekDisplay() {
            const start = formatDate(currentWeekStart);
            const end = formatDate(currentWeekEnd);
            document.getElementById('weekRange').textContent = `${start} - ${end}`;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // ========== 日曆生成 ==========
        function generateCalendar() {
            const dateRow = document.getElementById('dateRow');
            const calendarGrid = document.getElementById('calendarGrid');
            
            let dateHTML = '<div class="date-cell empty"></div>';
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dayLabel = DAYS[i === 6 ? 0 : i + 1];
                const dateNum = date.getDate();
                const isTodayClass = isToday(date) ? ' today' : '';
                
                dateHTML += `
                    <div class="date-cell day${isTodayClass}">
                        <span class="date-label">${dayLabel}</span>
                        <span class="date-number">${dateNum}</span>
                    </div>
                `;
            }
            dateRow.innerHTML = dateHTML;
            
            let gridHTML = '';
            let slotIndex = 0;
            
            for (let timeIndex = 0; timeIndex < TIME_SLOTS.length; timeIndex++) {
                gridHTML += `<div class="time-label">${TIME_SLOTS[timeIndex]}</div>`;
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    gridHTML += `<div class="slot-cell" data-index="${slotIndex}" onclick="toggleSlot(this)"></div>`;
                    slotIndex++;
                }
            }
            
            calendarGrid.innerHTML = gridHTML;
            restoreWeekSelection();
        }

        // ========== 時段選擇 ==========
        function toggleSlot(element) {
            // 如果是已預約,不允許操作
            if (element.classList.contains('booked')) {
                const studentName = element.getAttribute('data-student');
                showToast(`❌ 此時段已被「${studentName || '學員'}」預約,無法修改`);
                return;
            }
            
            // 如果是保留中,不允許操作
            if (element.classList.contains('reserved')) {
                const studentName = element.getAttribute('data-student');
                const remaining = element.getAttribute('data-remaining');
                showToast(`⏳ 此時段由「${studentName || '學員'}」保留中${remaining ? ',剩餘 ' + remaining : ''}`);
                return;
            }
            
            element.classList.toggle('selected');
            saveCurrentWeekSelection();
            updateStats();
        }

        function saveCurrentWeekSelection() {
            const weekKey = getWeekKey(currentWeekStart);
            const slots = [];
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                const index = parseInt(cell.dataset.index);
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                slots.push(`${dayIndex}-${timeIndex}`);
            });
            
            selectedSlots[weekKey] = slots;
            saveToLocalStorage();
        }

        function updateStats() {
            // 計算兩週內所有「可預約」的時段
            let totalSelected = 0;
            Object.keys(selectedSlots).forEach(weekKey => {
                totalSelected += (selectedSlots[weekKey] || []).length;
            });
            
            // 計算本週選擇的時段
            const weekCount = document.querySelectorAll('.slot-cell.selected').length;
            const totalSlots = document.querySelectorAll('.slot-cell').length;
            
            document.getElementById('totalSelected').textContent = totalSelected;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('totalCount').textContent = totalSlots;
        }

        // ========== 差異比對 ==========
        function compareSchedules() {
            const allSchedules = [];
            
            // 收集兩週內所有「可預約」的時段
            Object.keys(selectedSlots).forEach(weekKey => {
                const weekSlots = selectedSlots[weekKey] || [];
                const weekDate = new Date(weekKey);
                
                weekSlots.forEach(slotKey => {
                    const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                    const date = new Date(weekDate);
                    date.setDate(date.getDate() + dayIndex);
                    
                    const startTime = TIME_SLOTS[timeIndex];
                    const endTime = getEndTime(startTime);
                    
                    allSchedules.push({
                        weekKey,
                        dayIndex,
                        timeIndex,
                        date: formatDateISO(date),
                        day: DAYS_EN[dayIndex === 6 ? 0 : dayIndex + 1],
                        dayLabel: DAYS[dayIndex === 6 ? 0 : dayIndex + 1],
                        startTime: startTime,
                        endTime: endTime,
                        startDateTime: formatDateTime(date, startTime),
                        endDateTime: formatDateTime(date, endTime)
                    });
                });
            });
            
            // 收集所有原始排程中「可預約」的時段
            const allOriginalSchedules = [];
            Object.keys(originalSchedule).forEach(weekKey => {
                const weekSchedules = originalSchedule[weekKey] || [];
                weekSchedules.forEach(s => {
                    if (s.status === 'available') {
                        allOriginalSchedules.push(s);
                    }
                });
            });
            
            const added = [];
            const deleted = [];
            
            // 找出新增的時段
            allSchedules.forEach(slot => {
                const exists = allOriginalSchedules.find(
                    s => s.date === slot.date && s.startTime === slot.startTime
                );
                if (!exists) {
                    added.push(slot);
                }
            });
            
            // 找出刪除的時段
            allOriginalSchedules.forEach(slot => {
                const exists = allSchedules.find(
                    s => s.date === slot.date && s.startTime === slot.startTime
                );
                if (!exists) {
                    deleted.push(slot);
                }
            });
            
            return { added, deleted, all: allSchedules };
        }

        // ========== Modal 相關 ==========
        function showSaveModal() {
            const { added, deleted, all } = compareSchedules();
            
            document.getElementById('modalCoachName').textContent = currentTeacher;
            document.getElementById('modalCoachType').textContent = currentTeacherType + (currentClass ? ` | ${currentClass}` : '');
            document.getElementById('modalTotalCount').textContent = all.length;
            
            // 顯示變更資訊
            const changesInfo = document.getElementById('changesInfo');
            let changesHTML = '';
            
            if (added.length > 0) {
                changesHTML += `<div class="modal-note add">➕ 新增 ${added.length} 個時段</div>`;
            }
            
            if (deleted.length > 0) {
                changesHTML += `<div class="modal-note delete">➖ 刪除 ${deleted.length} 個時段</div>`;
            }
            
            if (added.length === 0 && deleted.length === 0 && all.length === 0) {
                changesHTML = '<div class="modal-note">🗑️ 清空所有排程</div>';
            } else if (added.length === 0 && deleted.length === 0) {
                changesHTML = '<div class="modal-note">ℹ️ 排程無變更</div>';
            }
            
            changesInfo.innerHTML = changesHTML;
            
            // 顯示確認排程列表
            const confirmList = document.getElementById('confirmScheduleList');
            const allChanges = [
                ...added.map(s => ({...s, type: 'add'})), 
                ...deleted.map(s => ({...s, type: 'delete'}))
            ];
            
            // 按日期排序
            allChanges.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            confirmList.innerHTML = allChanges.map(s => `
                <div class="schedule-item ${s.type}">
                    <div>
                        <div class="schedule-date">${s.date} (${s.dayLabel})</div>
                    </div>
                    <div class="schedule-time">${s.startTime} - ${s.endTime}</div>
                </div>
            `).join('');
            
            document.getElementById('saveModalOverlay').classList.remove('hidden');
        }

        function hideSaveModal() {
            document.getElementById('saveModalOverlay').classList.add('hidden');
        }

        // ========== 確認儲存 ==========
        async function confirmSave() {
            try {
                const { added, deleted, all } = compareSchedules();

                hideSaveModal();
                showToast('💾 正在送出排程...');

                console.log('📤 準備儲存資料...');
                console.log('新增:', added.length, '個時段');
                console.log('刪除:', deleted.length, '個時段');
                
                const allSlots = [
                    ...added.map(slot => ({
                        type: 'add',
                        userId: currentTeacher,
                        userName: currentTeacher,
                        coachType: currentTeacherType,
                        dayName: slot.dayLabel,
                        date: slot.date,
                        startTime: slot.startTime,
                        endTime: slot.endTime,
                        startDateTime: `${slot.date} ${slot.startTime}`,
                        endDateTime: `${slot.date} ${slot.endTime}`,
                        dayIndex: slot.dayIndex,
                        week: 0
                    })),
                    ...deleted.map(slot => ({
                        type: 'delete',
                        userId: currentTeacher,
                        userName: currentTeacher,
                        coachType: currentTeacherType,
                        dayName: slot.dayLabel,
                        date: slot.date,
                        startTime: slot.startTime,
                        endTime: slot.endTime,
                        startDateTime: `${slot.date} ${slot.startTime}`,
                        endDateTime: `${slot.date} ${slot.endTime}`,
                        dayIndex: slot.dayIndex,
                        week: 0
                    }))
                ];

                const payload = {
                    action: 'save',
                    userId: currentTeacher,
                    userName: currentTeacher,
                    userRole: 'coach',
                    coachType: currentTeacherType,
                    week: 0,
                    timestamp: new Date().toISOString(),
                    slots: allSlots,
                    totalSlots: allSlots.length,
                    summary: {
                        totalAdded: added.length,
                        totalDeleted: deleted.length
                    }
                };

                console.log('發送資料到 Make:', payload);
                
                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // 更新原始排程
                        all.forEach(slot => {
                            const weekKey = slot.weekKey;
                            if (!originalSchedule[weekKey]) {
                                originalSchedule[weekKey] = [];
                            }
                            
                            // 移除舊的記錄
                            originalSchedule[weekKey] = originalSchedule[weekKey].filter(
                                s => !(s.date === slot.date && s.startTime === slot.startTime && s.status === 'available')
                            );
                            
                            // 加入新記錄
                            originalSchedule[weekKey].push({
                                date: slot.date,
                                startTime: slot.startTime,
                                endTime: slot.endTime,
                                status: 'available'
                            });
                        });
                        
                        console.log('✅ 已同步到雲端');
                        showToast(`🎉 排程已送出!新增 ${added.length} 個,刪除 ${deleted.length} 個時段`);
                    } else {
                        console.warn('⚠️ 雲端同步失敗');
                        showToast('❌ 送出失敗,請稍後再試');
                    }
                } catch (networkError) {
                    console.warn('⚠️ 無法連接雲端:', networkError);
                    showToast('❌ 送出失敗,請檢查網路連線');
                }

            } catch (error) {
                console.error('❌ 儲存錯誤:', error);
                showToast('❌ 儲存時發生錯誤');
            }
        }

        // ========== 快速操作 ==========
        function copyLastWeek() {
            const lastWeekStart = new Date(currentWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekKey = getWeekKey(lastWeekStart);
            const lastWeekSlots = selectedSlots[lastWeekKey];
            
            if (!lastWeekSlots || lastWeekSlots.length === 0) {
                showToast('❌ 上週沒有排程資料');
                return;
            }
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            lastWeekSlots.forEach(slotKey => {
                const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                const cellIndex = timeIndex * 7 + dayIndex;
                const cell = document.querySelector(`.slot-cell[data-index="${cellIndex}"]`);
                if (cell && !cell.classList.contains('booked') && !cell.classList.contains('reserved')) {
                    cell.classList.add('selected');
                }
            });
            
            saveCurrentWeekSelection();
            updateStats();
            showToast(`🔄 已複製上週 ${lastWeekSlots.length} 個時段`);
        }

        function selectAll() {
            document.querySelectorAll('.slot-cell').forEach(slot => {
                if (!slot.classList.contains('booked') && !slot.classList.contains('reserved')) {
                    slot.classList.add('selected');
                }
            });
            saveCurrentWeekSelection();
            updateStats();
            showToast('⚡ 已全選本週可用時段');
        }

        function clearAll() {
            if (!confirm('確定要清除所有週次的已選時段嗎?(不影響已預約和保留中的時段)')) return;
            
            // 清除所有週次的資料
            selectedSlots = {};
            
            // 清除當前畫面上的選擇
            document.querySelectorAll('.slot-cell.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // 儲存到 LocalStorage
            saveToLocalStorage();
            updateStats();
            
            showToast('🧹 已清除所有週次的可預約時段');
        }

        // ========== 週次切換 ==========
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() - 7);
            updateWeekDisplay();
            generateCalendar();
            showToast('◀ 切換到上週');
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() + 7);
            updateWeekDisplay();
            generateCalendar();
            showToast('▶ 切換到下週');
        }

        // ========== 提示訊息 ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
