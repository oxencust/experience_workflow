<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™ç·´æ’ç¨‹ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
            --white: #ffffff;
            --gray: #808080;
            --bg: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* Loading ç•«é¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--green-light), var(--pink-light));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--green-light);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Error ç•«é¢ */
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
        }

        .error-screen.hidden {
            display: none;
        }

        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .error-message {
            font-size: 16px;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 24px;
            max-width: 400px;
        }

        .error-btn {
            padding: 14px 32px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .error-btn:hover {
            background: var(--green-dark);
        }

        /* ä¸»è¦å…§å®¹ */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .navbar {
            background: linear-gradient(135deg, var(--green-light), var(--pink-light), var(--yellow-light));
            padding: 16px 20px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--green), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .user-info h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 3px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 1px;
        }

        .user-info p:last-child {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0;
        }

        .container {
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.green::before { background: var(--green); }
        .stat-card.pink::before { background: var(--pink); }
        .stat-card.yellow::before { background: var(--yellow); }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
        }

        .stat-card.green .stat-value { color: var(--green); }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.yellow .stat-value { color: var(--yellow); }

        /* ç‹€æ…‹èªªæ˜å¡ç‰‡ */
        .legend-card {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .legend-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg);
        }

        .legend-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .legend-label {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .legend-item.available {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .legend-item.reserved {
            background: var(--yellow-light);
            color: var(--yellow-dark);
        }

        .legend-item.booked {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .quick-actions {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .quick-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .quick-btn {
            padding: 10px 6px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            font-family: inherit;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .quick-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quick-btn:active::before {
            opacity: 1;
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        .quick-btn:nth-child(1) {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .quick-btn:nth-child(1)::before {
            background: var(--blue);
        }

        .quick-btn:nth-child(2) {
            background: var(--yellow-light);
            color: var(--yellow-dark);
        }

        .quick-btn:nth-child(2)::before {
            background: var(--yellow);
        }

        .quick-btn:nth-child(3) {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .quick-btn:nth-child(3)::before {
            background: var(--green);
        }

        .quick-btn:nth-child(4) {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .quick-btn:nth-child(4)::before {
            background: var(--pink);
        }

        .quick-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .calendar-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--green-light);
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-nav button {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--green-light);
            color: var(--green-dark);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .week-nav button:active {
            transform: scale(0.95);
            background: var(--green);
            color: white;
        }

        #weekRange {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            min-width: 140px;
            text-align: center;
        }

        /* å›ºå®šæ—¥æœŸåˆ— */
        .calendar-wrapper {
            position: relative;
        }

        .date-header-sticky {
            position: sticky;
            top: 80px;
            background: var(--white);
            z-index: 50;
            margin: 0 -16px;
            padding: 10px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .date-row {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }

        .date-cell {
            text-align: center;
            padding: 6px 2px;
            border-radius: 6px;
            font-size: 11px;
        }

        .date-cell.empty {
            background: transparent;
        }

        .date-cell.day {
            background: var(--green-light);
            font-weight: 600;
            color: var(--green-dark);
        }

        .date-cell.day.today {
            background: var(--green);
            color: white;
            position: relative;
        }

        .date-cell.day.today::after {
            content: 'â—';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 6px;
        }

        .date-label {
            font-size: 9px;
            color: var(--text-light);
            display: block;
        }

        .date-number {
            font-size: 13px;
            font-weight: 600;
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 4px;
        }

        .time-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            padding: 6px 2px;
        }

        .slot-cell {
            border-radius: 6px;
            border: 2px solid var(--green-light);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 40px;
            height: 100%;
        }

        .slot-cell:active {
            transform: scale(0.92);
        }

        /* å¯é ç´„æ™‚æ®µ(å·²é¸æ“‡) */
        .slot-cell.selected {
            background: var(--green);
            border-color: var(--green-dark);
        }

        .slot-cell.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* ä¿ç•™ä¸­æ™‚æ®µ */
        .slot-cell.reserved {
            background: linear-gradient(135deg, var(--yellow), var(--yellow-dark));
            border-color: var(--yellow-dark);
            cursor: not-allowed;
            pointer-events: auto;
        }

        .slot-cell.reserved::after {
            content: 'â³';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        /* å€’æ•¸è¨ˆæ™‚é¡¯ç¤º */
        .slot-cell.reserved .countdown {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            line-height: 1;
        }

        /* Hover é¡¯ç¤ºä¿ç•™è³‡è¨Š */
        .slot-cell.reserved[data-student]:hover::before {
            content: 'ä¿ç•™ä¸­: ' attr(data-student) '\Aå‰©é¤˜: ' attr(data-remaining);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: pre;
            z-index: 100;
            text-align: center;
            line-height: 1.4;
            box-shadow: var(--shadow-md);
        }

        /* å·²é ç´„æ™‚æ®µ */
        .slot-cell.booked {
            background: linear-gradient(135deg, var(--blue), var(--blue-dark));
            border-color: var(--blue-dark);
            cursor: not-allowed;
            pointer-events: auto;
        }

        .slot-cell.booked::after {
            content: 'ğŸ‘¤';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        /* Hover é¡¯ç¤ºå­¸å“¡åç¨± */
        .slot-cell.booked[data-student]:hover::before {
            content: 'å·²é ç´„: ' attr(data-student);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.97);
            background: var(--green-dark);
        }

        .btn-secondary {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .btn-secondary:active {
            transform: scale(0.97);
            background: var(--pink);
            color: white;
        }

        /* ç¯„æœ¬ç®¡ç† */
        .template-section {
            background: var(--white);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--blue-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:active {
            transform: scale(0.98);
            background: var(--blue);
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-weight: 600;
            color: var(--blue-dark);
            font-size: 13px;
        }

        .template-count {
            font-size: 11px;
            color: var(--text-light);
        }

        .template-actions {
            display: flex;
            gap: 6px;
        }

        .template-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn.load {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .template-btn.delete {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: var(--shadow-lg);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .modal-content {
            margin-bottom: 16px;
        }

        .modal-info {
            background: var(--green-light);
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .modal-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .modal-info-row:last-child {
            border-bottom: none;
        }

        .modal-label {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
        }

        .modal-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-note {
            background: var(--yellow-light);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--yellow-dark);
            text-align: center;
            margin-bottom: 8px;
        }

        .modal-note.add {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .modal-note.delete {
            background: var(--pink-light);
            color: var(--pink-dark);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--green-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 12px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--green);
        }

        /* ç¢ºèªæ’ç¨‹åˆ—è¡¨ */
        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--green-light);
            border-radius: 8px;
        }

        .schedule-item.add {
            background: var(--green-light);
            border-left: 4px solid var(--green);
        }

        .schedule-item.delete {
            background: var(--pink-light);
            border-left: 4px solid var(--pink);
        }

        .schedule-date {
            font-weight: 600;
            color: var(--green-dark);
            font-size: 13px;
        }

        .schedule-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            transition: transform 0.3s;
            font-weight: 500;
            font-size: 14px;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* å¹³æ¿å„ªåŒ– */
        @media (min-width: 768px) {
            .navbar {
                padding: 20px;
            }

            .avatar {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .user-info h1 {
                font-size: 18px;
            }

            .user-info p {
                font-size: 14px;
            }

            .user-info p:last-child {
                font-size: 15px;
            }

            .container {
                padding: 20px;
            }

            .stats-grid {
                gap: 12px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 20px 16px;
            }

            .stat-icon {
                font-size: 28px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-value {
                font-size: 32px;
            }

            .quick-actions, .template-section, .calendar-card, .legend-card {
                padding: 16px;
                margin-bottom: 12px;
            }

            .quick-title, .legend-title {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .quick-btn {
                padding: 12px 8px;
                font-size: 13px;
            }

            .quick-icon {
                font-size: 24px;
                margin-bottom: 4px;
            }

            .calendar-header h2 {
                font-size: 18px;
            }

            .week-nav button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            #weekRange {
                font-size: 15px;
                min-width: 180px;
            }

            .date-header-sticky {
                top: 96px;
                padding: 12px 16px;
            }

            .date-row {
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 6px;
                margin-bottom: 12px;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }

            .date-cell {
                padding: 8px 4px;
                font-size: 12px;
            }

            .date-label {
                font-size: 10px;
            }

            .date-number {
                font-size: 14px;
            }

            .calendar-grid {
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 6px;
                max-width: 800px;
                margin: 0 auto;
            }

            .time-label {
                font-size: 11px;
                padding: 6px 4px;
                min-height: 50px;
            }

            .slot-cell {
                border-radius: 8px;
                min-height: 50px;
                height: 50px;
            }

            .slot-cell.selected::after,
            .slot-cell.reserved::after,
            .slot-cell.booked::after {
                font-size: 16px;
            }

            .btn {
                padding: 16px;
                font-size: 16px;
            }

            .template-name {
                font-size: 14px;
            }

            .template-count {
                font-size: 12px;
            }

            .template-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .schedule-date {
                font-size: 14px;
            }

            .schedule-time {
                font-size: 13px;
            }

            .modal {
                padding: 24px;
            }

            .modal-header {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .toast {
                font-size: 14px;
                padding: 16px 24px;
            }
        }

        /* æ¡Œé¢å„ªåŒ– */
        @media (min-width: 1024px) {
            .quick-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .calendar-grid {
                gap: 8px;
                max-width: 1000px;
                margin: 0 auto;
            }

            .time-label {
                padding: 6px 4px;
                min-height: 55px;
            }

            .slot-cell {
                min-height: 55px;
                height: 55px;
            }

            .date-row {
                gap: 8px;
                max-width: 1000px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 12px;
            }
        }

        /* å°è¢å¹•å„ªåŒ– */
        @media (max-width: 360px) {
            .quick-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-btn {
                padding: 8px 4px;
                font-size: 11px;
            }

            .quick-icon {
                font-size: 18px;
            }

            #weekRange {
                font-size: 12px;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading ç•«é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¼‰å…¥æ•™ç·´è³‡æ–™...</div>
    </div>

    <!-- Error ç•«é¢ -->
    <div class="error-screen hidden" id="errorScreen">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">ç„¡æ³•è¼‰å…¥è³‡æ–™</div>
        <div class="error-message" id="errorMessage">
            æ‰¾ä¸åˆ°æ•™ç·´è³‡æ–™,è«‹ç¢ºèªç¶²å€åƒæ•¸æ˜¯å¦æ­£ç¢ºã€‚
        </div>
        <button class="error-btn" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content" id="mainContent">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar">
            <div class="user-profile">
                <div class="avatar" id="avatarIcon">ğŸ‘¨â€ğŸ«</div>
                <div class="user-info">
                    <h1 id="systemTitle">æ•™ç·´æ’ç¨‹ç³»çµ±</h1>
                    <p id="teacherType">èª²ç¨‹é¡å‹</p>
                    <p id="teacherName">æ•™ç·´åç¨±</p>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-label">å…©é€±ç¸½è¨ˆ</div>
                    <div class="stat-value" id="totalSelected">0</div>
                </div>
                <div class="stat-card pink">
                    <div class="stat-icon">â°</div>
                    <div class="stat-label">æœ¬é€±é¸æ“‡</div>
                    <div class="stat-value" id="weekCount">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-label">ç¸½æ™‚æ®µ</div>
                    <div class="stat-value" id="totalCount">126</div>
                </div>
            </div>

            <!-- ç‹€æ…‹èªªæ˜ -->
            <div class="legend-card">
                <div class="legend-title">ğŸ¨ æ™‚æ®µç‹€æ…‹èªªæ˜</div>
                <div class="legend-grid">
                    <div class="legend-item available">
                        <div class="legend-icon">âœ“</div>
                        <div class="legend-label">å¯é ç´„</div>
                    </div>
                    <div class="legend-item reserved">
                        <div class="legend-icon">â³</div>
                        <div class="legend-label">ä¿ç•™ä¸­</div>
                    </div>
                    <div class="legend-item booked">
                        <div class="legend-icon">ğŸ‘¤</div>
                        <div class="legend-label">å·²é ç´„</div>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="quick-actions">
                <div class="quick-title">âš¡ å¿«é€Ÿæ“ä½œ</div>
                <div class="quick-grid">
                    <button class="quick-btn" onclick="copyLastWeek()">
                        <span class="quick-icon">ğŸ“‹</span>
                        è¤‡è£½ä¸Šé€±
                    </button>
                    <button class="quick-btn" onclick="showSaveTemplateModal()">
                        <span class="quick-icon">ğŸ’¾</span>
                        å„²å­˜ç¯„æœ¬
                    </button>
                    <button class="quick-btn" onclick="selectAll()">
                        <span class="quick-icon">âœ“</span>
                        å…¨é¸
                    </button>
                    <button class="quick-btn" onclick="clearAll()">
                        <span class="quick-icon">âœ•</span>
                        æ¸…é™¤
                    </button>
                </div>
            </div>

            <!-- ç¯„æœ¬ç®¡ç† -->
            <div class="template-section">
                <div class="template-header">
                    <div class="quick-title">ğŸ“š æˆ‘çš„ç¯„æœ¬</div>
                </div>
                <div class="template-list" id="templateList">
                    <div style="text-align: center; color: var(--text-light); padding: 16px; font-size: 12px;">
                        å°šç„¡å„²å­˜çš„ç¯„æœ¬
                    </div>
                </div>
            </div>

            <!-- æ—¥æ›† -->
            <div class="calendar-card">
                <div class="calendar-header">
                    <h2>ğŸ“… æ’ç¨‹ç®¡ç†</h2>
                    <div class="week-nav">
                        <button onclick="previousWeek()">â—€</button>
                        <span id="weekRange"></span>
                        <button onclick="nextWeek()">â–¶</button>
                    </div>
                </div>
                
                <div class="calendar-wrapper">
                    <!-- å›ºå®šçš„æ—¥æœŸæ¨™é¡Œ -->
                    <div class="date-header-sticky">
                        <div class="date-row" id="dateRow"></div>
                    </div>
                    
                    <!-- æ™‚é–“æ ¼å­ -->
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showSaveModal()">é€å‡ºæ’ç¨‹(å…©é€±å…§æ‰€æœ‰æ™‚æ®µ)</button>
            </div>
        </div>
    </div>

    <!-- å„²å­˜ç¢ºèª Modal -->
    <div class="modal-overlay hidden" id="saveModalOverlay">
        <div class="modal">
            <div class="modal-header">ğŸ’¾ ç¢ºèªé€å‡ºæ’ç¨‹(å…©é€±å…§æ‰€æœ‰æ™‚æ®µ)</div>
            <div class="modal-content">
                <div class="modal-info">
                    <div class="modal-info-row">
                        <span class="modal-label">æ•™ç·´</span>
                        <span class="modal-value" id="modalCoachName">-</span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-label">é¡å‹</span>
                        <span class="modal-value" id="modalCoachType">-</span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-label">å…©é€±ç¸½æ™‚æ®µ</span>
                        <span class="modal-value" id="modalTotalCount">0</span>
                    </div>
                </div>
                <div id="changesInfo"></div>
                <div class="schedule-list" id="confirmScheduleList"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideSaveModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmSave()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <!-- å„²å­˜ç¯„æœ¬ Modal -->
    <div class="modal-overlay hidden" id="saveTemplateModalOverlay">
        <div class="modal">
            <div class="modal-header">ğŸ’¾ å„²å­˜ç‚ºç¯„æœ¬</div>
            <div class="modal-content">
                <input type="text" class="modal-input" id="templateNameInput" placeholder="è«‹è¼¸å…¥ç¯„æœ¬åç¨±(ä¾‹å¦‚:é€±ä¸€ä¸‰äº”å›ºå®šç­)">
                <div class="modal-note">
                    å°‡ä¿å­˜ç›®å‰é¸æ“‡çš„ <span id="templateSlotCount">0</span> å€‹æ™‚æ®µ
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideSaveTemplateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmSaveTemplate()">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== é…ç½® ==========
        const SPREADSHEET_ID = '1WPrkqpOycQ0NvLmP8RYCIyxNl3Rn8kzfXFCIe50pfMg';
        const API_KEY = 'YOUR_GOOGLE_API_KEY';
        const SHEET_NAME = 'Sheet1';
        const WEBHOOK_URL = 'https://hook.us2.make.com/nohow7z27lfcp32ryrksdts3yhdoblxg';

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        const TIME_SLOTS = [
            '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
            '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
        ];
        const DAYS = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        const DAYS_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        let currentTeacher = '';
        let currentTeacherType = '';
        let currentClass = '';
        let currentWeekStart = getMonday(new Date());
        let currentWeekEnd = new Date(currentWeekStart);
        currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
        
        let originalSchedule = {}; // æŒ‰é€±å„²å­˜åŸå§‹æ’ç¨‹
        let selectedSlots = {};    // æŒ‰é€±å„²å­˜é¸æ“‡çš„æ™‚æ®µ(åªæœ‰ available)
        let reservedSlots = {};    // æŒ‰é€±å„²å­˜ä¿ç•™ä¸­çš„æ™‚æ®µ
        let bookedSlots = {};      // æŒ‰é€±å„²å­˜å·²é ç´„çš„æ™‚æ®µ
        let countdownIntervals = []; // å€’æ•¸è¨ˆæ™‚å™¨

        // ========== åˆå§‹åŒ– ==========
        window.onload = async function() {
            await initializeApp();
        };

        async function initializeApp() {
            try {
                console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const teacherParam = urlParams.get('teacher') || urlParams.get('coach') || urlParams.get('name');
                const typeParam = urlParams.get('type') || '';
                const classParam = urlParams.get('class') || '';
                
                console.log('ğŸ“Œ ç¶²å€åƒæ•¸:', { teacher: teacherParam, type: typeParam, class: classParam });
                
                if (!teacherParam) {
                    showError('ç¶²å€ç¼ºå°‘åƒæ•¸', 'è«‹ä½¿ç”¨æ­£ç¢ºçš„é€£çµ,ä¾‹å¦‚:?teacher=Kai&type=è‚Œè‚‰è³¦èƒ½ä¼¸å±•');
                    return;
                }

                // ç›´æ¥ä½¿ç”¨ç¶²å€åƒæ•¸
                currentTeacher = teacherParam;
                currentTeacherType = typeParam || 'æ•™ç·´';
                currentClass = classParam;

                console.log('âœ… æ•™ç·´è¨­å®šå®Œæˆ:', { name: currentTeacher, type: currentTeacherType });

                // æ›´æ–° UI
                document.getElementById('systemTitle').textContent = 'æ•™ç·´æ’ç¨‹ç³»çµ±';
                document.getElementById('teacherType').textContent = currentTeacherType;
                document.getElementById('teacherName').textContent = currentClass 
                    ? `${currentTeacher} | ${currentClass}` 
                    : currentTeacher;
                
                const avatarIcon = getAvatarIcon(currentTeacherType);
                document.getElementById('avatarIcon').textContent = avatarIcon;

                updateWeekDisplay();
                generateCalendar();

                // å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™
                console.log('â˜ï¸ é–‹å§‹è¼‰å…¥é›²ç«¯æ’ç¨‹...');
                await loadScheduleFromCloud();
                
                // å¦‚æœé›²ç«¯æ²’æœ‰è³‡æ–™,æ‰ä½¿ç”¨ LocalStorage
                if (Object.keys(selectedSlots).length === 0 && Object.keys(reservedSlots).length === 0 && Object.keys(bookedSlots).length === 0) {
                    console.log('ğŸ’¾ é›²ç«¯ç„¡è³‡æ–™,è¼‰å…¥æœ¬åœ°å‚™ä»½...');
                    loadFromLocalStorage();
                }

                loadTemplates();
                updateStats();

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ!');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('show');

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', error);
                showError('è¼‰å…¥å¤±æ•—', 'ç„¡æ³•è¼‰å…¥æ•™ç·´è³‡æ–™:' + error.message);
            }
        }

        // ========== å¾é›²ç«¯è¼‰å…¥æ’ç¨‹ ==========
        async function loadScheduleFromCloud() {
            try {
                console.log('ğŸ“¥ æ­£åœ¨å¾é›²ç«¯è¼‰å…¥æ’ç¨‹...');
                
                // è¨ˆç®—å…©é€±ç¯„åœ
                const endDate = new Date(currentWeekStart);
                endDate.setDate(endDate.getDate() + 14);
                
                const payload = {
                    action: 'load',
                    userName: currentTeacher,
                    coachType: currentTeacherType,
                    startDate: formatDateISO(currentWeekStart),
                    endDate: formatDateISO(endDate)
                };
                
                console.log('ğŸ“¤ ç™¼é€è«‹æ±‚:', payload);
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('ğŸ“¨ å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);

                if (!response.ok) {
                    console.warn('âš ï¸ é›²ç«¯è¼‰å…¥å¤±æ•—:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('ğŸ“¦ æ”¶åˆ°è³‡æ–™:', data);
                
                if (data.success && data.schedules && data.schedules.length > 0) {
                    console.log(`âœ… å¾é›²ç«¯è¼‰å…¥ ${data.schedules.length} å€‹æ’ç¨‹`);
                    
                    // æ¸…ç©ºç¾æœ‰è³‡æ–™
                    originalSchedule = {};
                    selectedSlots = {};
                    reservedSlots = {};
                    bookedSlots = {};
                    
                    // è™•ç†æ¯å€‹æ’ç¨‹
                    data.schedules.forEach((schedule, index) => {
                        console.log(`è™•ç†æ’ç¨‹ ${index + 1}:`, schedule);
                        
                        const date = new Date(schedule.date);
                        const weekStart = getMonday(date);
                        const weekKey = getWeekKey(weekStart);
                        
                        const dayOfWeek = date.getDay();
                        const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                        
                        const timeIndex = TIME_SLOTS.indexOf(schedule.startTime);
                        const slotKey = `${dayIndex}-${timeIndex}`;
                        
                        console.log(`  æ—¥æœŸ: ${schedule.date}, æ˜ŸæœŸ: ${dayOfWeek}, dayIndex: ${dayIndex}, timeIndex: ${timeIndex}`);
                        console.log(`  ç‹€æ…‹: ${schedule.status}, å­¸ç”Ÿ: ${schedule.studentName || 'ç„¡'}`);
                        
                        if (timeIndex >= 0) {
                            // å„²å­˜åˆ° originalSchedule
                            if (!originalSchedule[weekKey]) {
                                originalSchedule[weekKey] = [];
                            }
                            originalSchedule[weekKey].push({
                                date: schedule.date,
                                startTime: schedule.startTime,
                                endTime: schedule.endTime || getEndTime(schedule.startTime),
                                endDate: schedule.endDate || schedule.date,
                                status: schedule.status || 'available',
                                studentName: schedule.studentName || '',
                                reservedUntil: schedule.reservedUntil || ''
                            });
                            
                            // æ ¹æ“šç‹€æ…‹åˆ†é¡å„²å­˜
                            if (schedule.status === 'available' || !schedule.status) {
                                // å¯é ç´„ â†’ åŠ å…¥ selectedSlots
                                if (!selectedSlots[weekKey]) {
                                    selectedSlots[weekKey] = [];
                                }
                                if (!selectedSlots[weekKey].includes(slotKey)) {
                                    selectedSlots[weekKey].push(slotKey);
                                    console.log(`  âœ… åŠ å…¥ selectedSlots: ${slotKey}`);
                                }
                            } else if (schedule.status === 'reserved') {
                                // ä¿ç•™ä¸­ â†’ åŠ å…¥ reservedSlots
                                if (!reservedSlots[weekKey]) {
                                    reservedSlots[weekKey] = [];
                                }
                                reservedSlots[weekKey].push({
                                    slotKey: slotKey,
                                    studentName: schedule.studentName || 'å­¸å“¡',
                                    reservedUntil: schedule.reservedUntil,
                                    date: schedule.date,
                                    startTime: schedule.startTime
                                });
                                console.log(`  â³ åŠ å…¥ reservedSlots: ${slotKey}, å­¸ç”Ÿ: ${schedule.studentName}`);
                            } else if (schedule.status === 'booked') {
                                // å·²é ç´„ â†’ åŠ å…¥ bookedSlots
                                if (!bookedSlots[weekKey]) {
                                    bookedSlots[weekKey] = [];
                                }
                                bookedSlots[weekKey].push({
                                    slotKey: slotKey,
                                    studentName: schedule.studentName || 'å­¸å“¡',
                                    date: schedule.date,
                                    startTime: schedule.startTime
                                });
                                console.log(`  ğŸ‘¤ åŠ å…¥ bookedSlots: ${slotKey}, å­¸ç”Ÿ: ${schedule.studentName}`);
                            }
                        } else {
                            console.warn(`  âš ï¸ ç„¡æ•ˆçš„æ™‚é–“: ${schedule.startTime}`);
                        }
                    });
                    
                    console.log('ğŸ“Š è™•ç†å®Œæˆ:', {
                        originalSchedule: Object.keys(originalSchedule).length,
                        selectedSlots: Object.keys(selectedSlots).reduce((sum, key) => sum + selectedSlots[key].length, 0),
                        reservedSlots: Object.keys(reservedSlots).reduce((sum, key) => sum + reservedSlots[key].length, 0),
                        bookedSlots: Object.keys(bookedSlots).reduce((sum, key) => sum + bookedSlots[key].length, 0)
                    });
                    
                    saveToLocalStorage();
                    restoreWeekSelection();
                    updateStats();
                    
                    showToast(`âœ… å·²è¼‰å…¥ ${data.schedules.length} å€‹æ’ç¨‹`);
                    
                } else {
                    console.log('â„¹ï¸ é›²ç«¯ç„¡æ’ç¨‹è³‡æ–™');
                }

            } catch (error) {
                console.error('âŒ è¼‰å…¥é›²ç«¯æ’ç¨‹å¤±æ•—:', error);
                showToast('âš ï¸ ç„¡æ³•é€£æ¥é›²ç«¯,ä½¿ç”¨æœ¬åœ°è³‡æ–™');
            }
        }

        // ========== Google Sheets API (å·²åœç”¨,æ”¹ç”¨ç¶²å€åƒæ•¸) ==========
        // ä¿ç•™å‡½æ•¸ä»¥é˜²æœªä¾†éœ€è¦,ä½†ç›®å‰ä¸ä½¿ç”¨
        
        function getAvatarIcon(type) {
            const icons = {
                'AI 3Dé«”æ…‹æª¢æ¸¬': 'ğŸ¤–',
                'çš®æ‹‰ææ–¯': 'ğŸ§˜',
                'é‡è¨“': 'ğŸ’ª',
                'è‚Œè‚‰è³¦èƒ½ä¼¸å±•': 'ğŸ¤¸'
            };
            return icons[type] || 'ğŸ‘¨â€ğŸ«';
        }

        function showError(title, message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.querySelector('.error-title').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }

        // ========== LocalStorage ç›¸é—œ ==========
        function saveToLocalStorage() {
            const storageKey = `coachSchedule_${currentTeacher}_${currentClass}`;
            const data = {
                teacher: currentTeacher,
                type: currentTeacherType,
                class: currentClass,
                selectedSlots: selectedSlots,
                reservedSlots: reservedSlots,
                bookedSlots: bookedSlots
            };
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const storageKey = `coachSchedule_${currentTeacher}_${currentClass}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                const data = JSON.parse(saved);
                selectedSlots = data.selectedSlots || {};
                reservedSlots = data.reservedSlots || {};
                bookedSlots = data.bookedSlots || {};
                restoreWeekSelection();
            }
        }

        function restoreWeekSelection() {
            const weekKey = getWeekKey(currentWeekStart);
            const weekSlots = selectedSlots[weekKey] || [];
            const weekReserved = reservedSlots[weekKey] || [];
            const weekBooked = bookedSlots[weekKey] || [];
            
            console.log('ğŸ”„ æ¢å¾©æœ¬é€±é¸æ“‡:', {
                weekKey,
                available: weekSlots.length,
                reserved: weekReserved.length,
                booked: weekBooked.length
            });
            
            // æ¸…é™¤èˆŠçš„å€’æ•¸è¨ˆæ™‚å™¨
            countdownIntervals.forEach(interval => clearInterval(interval));
            countdownIntervals = [];
            
            document.querySelectorAll('.slot-cell').forEach((cell, index) => {
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                const slotKey = `${dayIndex}-${timeIndex}`;
                
                // æ¸…é™¤æ‰€æœ‰ç‹€æ…‹
                cell.classList.remove('selected', 'booked', 'reserved');
                cell.removeAttribute('data-student');
                cell.removeAttribute('data-remaining');
                cell.innerHTML = '';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºå·²é ç´„
                const bookedSlot = weekBooked.find(b => b.slotKey === slotKey);
                if (bookedSlot) {
                    cell.classList.add('booked');
                    if (bookedSlot.studentName) {
                        cell.setAttribute('data-student', bookedSlot.studentName);
                    }
                    console.log(`  ğŸ‘¤ å·²é ç´„: ${slotKey}, å­¸ç”Ÿ: ${bookedSlot.studentName}`);
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä¿ç•™ä¸­
                const reservedSlot = weekReserved.find(r => r.slotKey === slotKey);
                if (reservedSlot) {
                    cell.classList.add('reserved');
                    if (reservedSlot.studentName) {
                        cell.setAttribute('data-student', reservedSlot.studentName);
                    }
                    console.log(`  â³ ä¿ç•™ä¸­: ${slotKey}, å­¸ç”Ÿ: ${reservedSlot.studentName}, æœŸé™: ${reservedSlot.reservedUntil}`);
                    
                    // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
                    if (reservedSlot.reservedUntil) {
                        startCountdown(cell, reservedSlot.reservedUntil, weekKey, slotKey);
                    }
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºå¯é ç´„(å·²é¸æ“‡)
                if (weekSlots.includes(slotKey)) {
                    cell.classList.add('selected');
                    console.log(`  âœ… å¯é ç´„: ${slotKey}`);
                }
            });
            
            updateStats();
        }

        // ========== å€’æ•¸è¨ˆæ™‚ ==========
        function startCountdown(cell, reservedUntil, weekKey, slotKey) {
            const updateCountdown = () => {
                const now = new Date();
                const until = new Date(reservedUntil);
                const diff = until - now;
                
                if (diff <= 0) {
                    // æ™‚é–“åˆ°äº†,è‡ªå‹•é‡‹æ”¾
                    cell.classList.remove('reserved');
                    cell.classList.add('selected');
                    cell.removeAttribute('data-student');
                    cell.removeAttribute('data-remaining');
                    cell.innerHTML = '';
                    
                    // å¾ reservedSlots ç§»é™¤
                    if (reservedSlots[weekKey]) {
                        reservedSlots[weekKey] = reservedSlots[weekKey].filter(
                            r => r.slotKey !== slotKey
                        );
                    }
                    
                    // åŠ å…¥ selectedSlots
                    if (!selectedSlots[weekKey]) {
                        selectedSlots[weekKey] = [];
                    }
                    if (!selectedSlots[weekKey].includes(slotKey)) {
                        selectedSlots[weekKey].push(slotKey);
                    }
                    
                    saveToLocalStorage();
                    updateStats();
                    showToast('â° ä¿ç•™æ™‚é–“å·²åˆ°,æ™‚æ®µå·²è‡ªå‹•é‡‹æ”¾');
                    
                    return true; // åœæ­¢è¨ˆæ™‚
                }
                
                // è¨ˆç®—å‰©é¤˜æ™‚é–“
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                // æ›´æ–°é¡¯ç¤º
                cell.setAttribute('data-remaining', `${minutes}åˆ†${seconds}ç§’`);
                
                // åœ¨æ ¼å­ä¸Šé¡¯ç¤ºå‰©é¤˜åˆ†é˜æ•¸
                let countdownDiv = cell.querySelector('.countdown');
                if (!countdownDiv) {
                    countdownDiv = document.createElement('div');
                    countdownDiv.className = 'countdown';
                    cell.appendChild(countdownDiv);
                }
                countdownDiv.textContent = `${minutes}m`;
                
                return false;
            };
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            if (updateCountdown()) return;
            
            // æ¯ç§’æ›´æ–°
            const interval = setInterval(() => {
                if (updateCountdown()) {
                    clearInterval(interval);
                }
            }, 1000);
            
            countdownIntervals.push(interval);
        }

        function getWeekKey(date) {
            return formatDateISO(date);
        }

        // ========== ç¯„æœ¬ç®¡ç† ==========
        function loadTemplates() {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const templateList = document.getElementById('templateList');
            
            if (templates.length === 0) {
                templateList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 16px; font-size: 12px;">å°šç„¡å„²å­˜çš„ç¯„æœ¬</div>';
                return;
            }
            
            templateList.innerHTML = templates.map((template, index) => `
                <div class="template-item">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <div class="template-count">${template.slots.length} å€‹æ™‚æ®µ</div>
                    </div>
                    <div class="template-actions">
                        <button class="template-btn load" onclick="loadTemplate(${index})">è¼‰å…¥</button>
                        <button class="template-btn delete" onclick="deleteTemplate(${index})">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function showSaveTemplateModal() {
            const count = document.querySelectorAll('.slot-cell.selected').length;
            if (count === 0) {
                showToast('âŒ è«‹å…ˆé¸æ“‡è¦å„²å­˜çš„æ™‚æ®µ');
                return;
            }
            
            document.getElementById('templateSlotCount').textContent = count;
            document.getElementById('templateNameInput').value = '';
            document.getElementById('saveTemplateModalOverlay').classList.remove('hidden');
        }

        function hideSaveTemplateModal() {
            document.getElementById('saveTemplateModalOverlay').classList.add('hidden');
        }

        function confirmSaveTemplate() {
            const name = document.getElementById('templateNameInput').value.trim();
            if (!name) {
                showToast('âŒ è«‹è¼¸å…¥ç¯„æœ¬åç¨±');
                return;
            }
            
            const selectedCells = document.querySelectorAll('.slot-cell.selected');
            const slots = [];
            
            selectedCells.forEach(cell => {
                const index = parseInt(cell.dataset.index);
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                slots.push(`${dayIndex}-${timeIndex}`);
            });
            
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            templates.push({
                name: name,
                slots: slots,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem(storageKey, JSON.stringify(templates));
            
            hideSaveTemplateModal();
            loadTemplates();
            showToast(`ğŸ’¾ ç¯„æœ¬ã€Œ${name}ã€å·²å„²å­˜`);
        }

        function loadTemplate(index) {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const template = templates[index];
            
            if (!template) return;
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            template.slots.forEach(slotKey => {
                const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                const cellIndex = timeIndex * 7 + dayIndex;
                const cell = document.querySelector(`.slot-cell[data-index="${cellIndex}"]`);
                if (cell && !cell.classList.contains('booked') && !cell.classList.contains('reserved')) {
                    cell.classList.add('selected');
                }
            });
            
            saveCurrentWeekSelection();
            updateStats();
            showToast(`âœ“ å·²è¼‰å…¥ç¯„æœ¬ã€Œ${template.name}ã€`);
        }

        function deleteTemplate(index) {
            const storageKey = `scheduleTemplates_${currentTeacher}_${currentClass}`;
            const templates = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const template = templates[index];
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç¯„æœ¬ã€Œ${template.name}ã€å—?`)) return;
            
            templates.splice(index, 1);
            localStorage.setItem(storageKey, JSON.stringify(templates));
            
            loadTemplates();
            showToast(`ğŸ—‘ï¸ å·²åˆªé™¤ç¯„æœ¬ã€Œ${template.name}ã€`);
        }

        // ========== æ—¥æœŸè™•ç† ==========
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateTime(date, time) {
            return `${formatDateISO(date)}T${time}:00`;
        }

        function getEndTime(startTime) {
            const [hour, minute] = startTime.split(':').map(Number);
            const endHour = hour + 1;
            return `${String(endHour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }

        function updateWeekDisplay() {
            const start = formatDate(currentWeekStart);
            const end = formatDate(currentWeekEnd);
            document.getElementById('weekRange').textContent = `${start} - ${end}`;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // ========== æ—¥æ›†ç”Ÿæˆ ==========
        function generateCalendar() {
            const dateRow = document.getElementById('dateRow');
            const calendarGrid = document.getElementById('calendarGrid');
            
            let dateHTML = '<div class="date-cell empty"></div>';
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dayLabel = DAYS[i === 6 ? 0 : i + 1];
                const dateNum = date.getDate();
                const isTodayClass = isToday(date) ? ' today' : '';
                
                dateHTML += `
                    <div class="date-cell day${isTodayClass}">
                        <span class="date-label">${dayLabel}</span>
                        <span class="date-number">${dateNum}</span>
                    </div>
                `;
            }
            dateRow.innerHTML = dateHTML;
            
            let gridHTML = '';
            let slotIndex = 0;
            
            for (let timeIndex = 0; timeIndex < TIME_SLOTS.length; timeIndex++) {
                gridHTML += `<div class="time-label">${TIME_SLOTS[timeIndex]}</div>`;
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    gridHTML += `<div class="slot-cell" data-index="${slotIndex}" onclick="toggleSlot(this)"></div>`;
                    slotIndex++;
                }
            }
            
            calendarGrid.innerHTML = gridHTML;
            restoreWeekSelection();
        }

        // ========== æ™‚æ®µé¸æ“‡ ==========
        function toggleSlot(element) {
            // å¦‚æœæ˜¯å·²é ç´„,ä¸å…è¨±æ“ä½œ
            if (element.classList.contains('booked')) {
                const studentName = element.getAttribute('data-student');
                showToast(`âŒ æ­¤æ™‚æ®µå·²è¢«ã€Œ${studentName || 'å­¸å“¡'}ã€é ç´„,ç„¡æ³•ä¿®æ”¹`);
                return;
            }
            
            // å¦‚æœæ˜¯ä¿ç•™ä¸­,ä¸å…è¨±æ“ä½œ
            if (element.classList.contains('reserved')) {
                const studentName = element.getAttribute('data-student');
                const remaining = element.getAttribute('data-remaining');
                showToast(`â³ æ­¤æ™‚æ®µç”±ã€Œ${studentName || 'å­¸å“¡'}ã€ä¿ç•™ä¸­${remaining ? ',å‰©é¤˜ ' + remaining : ''}`);
                return;
            }
            
            element.classList.toggle('selected');
            saveCurrentWeekSelection();
            updateStats();
        }

        function saveCurrentWeekSelection() {
            const weekKey = getWeekKey(currentWeekStart);
            const slots = [];
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                const index = parseInt(cell.dataset.index);
                const dayIndex = index % 7;
                const timeIndex = Math.floor(index / 7);
                slots.push(`${dayIndex}-${timeIndex}`);
            });
            
            selectedSlots[weekKey] = slots;
            saveToLocalStorage();
        }

        function updateStats() {
            // è¨ˆç®—å…©é€±å…§æ‰€æœ‰ã€Œå¯é ç´„ã€çš„æ™‚æ®µ
            let totalSelected = 0;
            Object.keys(selectedSlots).forEach(weekKey => {
                totalSelected += (selectedSlots[weekKey] || []).length;
            });
            
            // è¨ˆç®—æœ¬é€±é¸æ“‡çš„æ™‚æ®µ
            const weekCount = document.querySelectorAll('.slot-cell.selected').length;
            const totalSlots = document.querySelectorAll('.slot-cell').length;
            
            document.getElementById('totalSelected').textContent = totalSelected;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('totalCount').textContent = totalSlots;
        }

        // ========== å·®ç•°æ¯”å° ==========
        function compareSchedules() {
            const allSchedules = [];
            
            // æ”¶é›†å…©é€±å…§æ‰€æœ‰ã€Œå¯é ç´„ã€çš„æ™‚æ®µ
            Object.keys(selectedSlots).forEach(weekKey => {
                const weekSlots = selectedSlots[weekKey] || [];
                const weekDate = new Date(weekKey);
                
                weekSlots.forEach(slotKey => {
                    const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                    const date = new Date(weekDate);
                    date.setDate(date.getDate() + dayIndex);
                    
                    const startTime = TIME_SLOTS[timeIndex];
                    const endTime = getEndTime(startTime);
                    
                    allSchedules.push({
                        weekKey,
                        dayIndex,
                        timeIndex,
                        date: formatDateISO(date),
                        day: DAYS_EN[dayIndex === 6 ? 0 : dayIndex + 1],
                        dayLabel: DAYS[dayIndex === 6 ? 0 : dayIndex + 1],
                        startTime: startTime,
                        endTime: endTime,
                        startDateTime: formatDateTime(date, startTime),
                        endDateTime: formatDateTime(date, endTime)
                    });
                });
            });
            
            // æ”¶é›†æ‰€æœ‰åŸå§‹æ’ç¨‹ä¸­ã€Œå¯é ç´„ã€çš„æ™‚æ®µ
            const allOriginalSchedules = [];
            Object.keys(originalSchedule).forEach(weekKey => {
                const weekSchedules = originalSchedule[weekKey] || [];
                weekSchedules.forEach(s => {
                    if (s.status === 'available') {
                        allOriginalSchedules.push(s);
                    }
                });
            });
            
            const added = [];
            const deleted = [];
            
            // æ‰¾å‡ºæ–°å¢çš„æ™‚æ®µ
            allSchedules.forEach(slot => {
                const exists = allOriginalSchedules.find(
                    s => s.date === slot.date && s.startTime === slot.startTime
                );
                if (!exists) {
                    added.push(slot);
                }
            });
            
            // æ‰¾å‡ºåˆªé™¤çš„æ™‚æ®µ
            allOriginalSchedules.forEach(slot => {
                const exists = allSchedules.find(
                    s => s.date === slot.date && s.startTime === slot.startTime
                );
                if (!exists) {
                    deleted.push(slot);
                }
            });
            
            return { added, deleted, all: allSchedules };
        }

        // ========== Modal ç›¸é—œ ==========
        function showSaveModal() {
            const { added, deleted, all } = compareSchedules();
            
            document.getElementById('modalCoachName').textContent = currentTeacher;
            document.getElementById('modalCoachType').textContent = currentTeacherType + (currentClass ? ` | ${currentClass}` : '');
            document.getElementById('modalTotalCount').textContent = all.length;
            
            // é¡¯ç¤ºè®Šæ›´è³‡è¨Š
            const changesInfo = document.getElementById('changesInfo');
            let changesHTML = '';
            
            if (added.length > 0) {
                changesHTML += `<div class="modal-note add">â• æ–°å¢ ${added.length} å€‹æ™‚æ®µ</div>`;
            }
            
            if (deleted.length > 0) {
                changesHTML += `<div class="modal-note delete">â– åˆªé™¤ ${deleted.length} å€‹æ™‚æ®µ</div>`;
            }
            
            if (added.length === 0 && deleted.length === 0 && all.length === 0) {
                changesHTML = '<div class="modal-note">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ’ç¨‹</div>';
            } else if (added.length === 0 && deleted.length === 0) {
                changesHTML = '<div class="modal-note">â„¹ï¸ æ’ç¨‹ç„¡è®Šæ›´</div>';
            }
            
            changesInfo.innerHTML = changesHTML;
            
            // é¡¯ç¤ºç¢ºèªæ’ç¨‹åˆ—è¡¨
            const confirmList = document.getElementById('confirmScheduleList');
            const allChanges = [
                ...added.map(s => ({...s, type: 'add'})), 
                ...deleted.map(s => ({...s, type: 'delete'}))
            ];
            
            // æŒ‰æ—¥æœŸæ’åº
            allChanges.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            confirmList.innerHTML = allChanges.map(s => `
                <div class="schedule-item ${s.type}">
                    <div>
                        <div class="schedule-date">${s.date} (${s.dayLabel})</div>
                    </div>
                    <div class="schedule-time">${s.startTime} - ${s.endTime}</div>
                </div>
            `).join('');
            
            document.getElementById('saveModalOverlay').classList.remove('hidden');
        }

        function hideSaveModal() {
            document.getElementById('saveModalOverlay').classList.add('hidden');
        }

        // ========== ç¢ºèªå„²å­˜ ==========
        async function confirmSave() {
            try {
                const { added, deleted, all } = compareSchedules();

                hideSaveModal();
                showToast('ğŸ’¾ æ­£åœ¨é€å‡ºæ’ç¨‹...');

                console.log('ğŸ“¤ æº–å‚™å„²å­˜è³‡æ–™...');
                console.log('æ–°å¢:', added.length, 'å€‹æ™‚æ®µ');
                console.log('åˆªé™¤:', deleted.length, 'å€‹æ™‚æ®µ');
                
                const allSlots = [
                    ...added.map(slot => ({
                        type: 'add',
                        userId: currentTeacher,
                        userName: currentTeacher,
                        coachType: currentTeacherType,
                        dayName: slot.dayLabel,
                        date: slot.date,
                        startTime: slot.startTime,
                        endTime: slot.endTime,
                        startDateTime: `${slot.date} ${slot.startTime}`,
                        endDateTime: `${slot.date} ${slot.endTime}`,
                        dayIndex: slot.dayIndex,
                        week: 0
                    })),
                    ...deleted.map(slot => ({
                        type: 'delete',
                        userId: currentTeacher,
                        userName: currentTeacher,
                        coachType: currentTeacherType,
                        dayName: slot.dayLabel,
                        date: slot.date,
                        startTime: slot.startTime,
                        endTime: slot.endTime,
                        startDateTime: `${slot.date} ${slot.startTime}`,
                        endDateTime: `${slot.date} ${slot.endTime}`,
                        dayIndex: slot.dayIndex,
                        week: 0
                    }))
                ];

                const payload = {
                    action: 'save',
                    userId: currentTeacher,
                    userName: currentTeacher,
                    userRole: 'coach',
                    coachType: currentTeacherType,
                    week: 0,
                    timestamp: new Date().toISOString(),
                    slots: allSlots,
                    totalSlots: allSlots.length,
                    summary: {
                        totalAdded: added.length,
                        totalDeleted: deleted.length
                    }
                };

                console.log('ç™¼é€è³‡æ–™åˆ° Make:', payload);
                
                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // æ›´æ–°åŸå§‹æ’ç¨‹
                        all.forEach(slot => {
                            const weekKey = slot.weekKey;
                            if (!originalSchedule[weekKey]) {
                                originalSchedule[weekKey] = [];
                            }
                            
                            // ç§»é™¤èˆŠçš„è¨˜éŒ„
                            originalSchedule[weekKey] = originalSchedule[weekKey].filter(
                                s => !(s.date === slot.date && s.startTime === slot.startTime && s.status === 'available')
                            );
                            
                            // åŠ å…¥æ–°è¨˜éŒ„
                            originalSchedule[weekKey].push({
                                date: slot.date,
                                startTime: slot.startTime,
                                endTime: slot.endTime,
                                status: 'available'
                            });
                        });
                        
                        console.log('âœ… å·²åŒæ­¥åˆ°é›²ç«¯');
                        showToast(`ğŸ‰ æ’ç¨‹å·²é€å‡º!æ–°å¢ ${added.length} å€‹,åˆªé™¤ ${deleted.length} å€‹æ™‚æ®µ`);
                    } else {
                        console.warn('âš ï¸ é›²ç«¯åŒæ­¥å¤±æ•—');
                        showToast('âŒ é€å‡ºå¤±æ•—,è«‹ç¨å¾Œå†è©¦');
                    }
                } catch (networkError) {
                    console.warn('âš ï¸ ç„¡æ³•é€£æ¥é›²ç«¯:', networkError);
                    showToast('âŒ é€å‡ºå¤±æ•—,è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }

            } catch (error) {
                console.error('âŒ å„²å­˜éŒ¯èª¤:', error);
                showToast('âŒ å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // ========== å¿«é€Ÿæ“ä½œ ==========
        function copyLastWeek() {
            const lastWeekStart = new Date(currentWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekKey = getWeekKey(lastWeekStart);
            const lastWeekSlots = selectedSlots[lastWeekKey];
            
            if (!lastWeekSlots || lastWeekSlots.length === 0) {
                showToast('âŒ ä¸Šé€±æ²’æœ‰æ’ç¨‹è³‡æ–™');
                return;
            }
            
            document.querySelectorAll('.slot-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            lastWeekSlots.forEach(slotKey => {
                const [dayIndex, timeIndex] = slotKey.split('-').map(Number);
                const cellIndex = timeIndex * 7 + dayIndex;
                const cell = document.querySelector(`.slot-cell[data-index="${cellIndex}"]`);
                if (cell && !cell.classList.contains('booked') && !cell.classList.contains('reserved')) {
                    cell.classList.add('selected');
                }
            });
            
            saveCurrentWeekSelection();
            updateStats();
            showToast(`ğŸ”„ å·²è¤‡è£½ä¸Šé€± ${lastWeekSlots.length} å€‹æ™‚æ®µ`);
        }

        function selectAll() {
            document.querySelectorAll('.slot-cell').forEach(slot => {
                if (!slot.classList.contains('booked') && !slot.classList.contains('reserved')) {
                    slot.classList.add('selected');
                }
            });
            saveCurrentWeekSelection();
            updateStats();
            showToast('âš¡ å·²å…¨é¸æœ¬é€±å¯ç”¨æ™‚æ®µ');
        }

        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é€±æ¬¡çš„å·²é¸æ™‚æ®µå—?(ä¸å½±éŸ¿å·²é ç´„å’Œä¿ç•™ä¸­çš„æ™‚æ®µ)')) return;
            
            // æ¸…é™¤æ‰€æœ‰é€±æ¬¡çš„è³‡æ–™
            selectedSlots = {};
            
            // æ¸…é™¤ç•¶å‰ç•«é¢ä¸Šçš„é¸æ“‡
            document.querySelectorAll('.slot-cell.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // å„²å­˜åˆ° LocalStorage
            saveToLocalStorage();
            updateStats();
            
            showToast('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰é€±æ¬¡çš„å¯é ç´„æ™‚æ®µ');
        }

        // ========== é€±æ¬¡åˆ‡æ› ==========
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() - 7);
            updateWeekDisplay();
            generateCalendar();
            showToast('â—€ åˆ‡æ›åˆ°ä¸Šé€±');
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() + 7);
            updateWeekDisplay();
            generateCalendar();
            showToast('â–¶ åˆ‡æ›åˆ°ä¸‹é€±');
        }

        // ========== æç¤ºè¨Šæ¯ ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
